<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Ã‡aÄŸlayan Ailesi â€“ 3D Aile AÄŸacÄ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0;background:#0b1020;color:#eaf2ff;font-family:system-ui,Segoe UI,Roboto}
    #app{position:fixed;inset:0}
    .hud{position:fixed;left:12px;top:12px;display:flex;flex-wrap:wrap;gap:8px;z-index:10}
    .btn{background:#13203d;border:1px solid #1f2f57;color:#eaf2ff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#5ea0ff}
    .hint{position:fixed;right:12px;top:12px;opacity:.75;font-size:14px;z-index:5}
    .credit{position:fixed;right:12px;bottom:12px;opacity:.6;font-size:12px}
    .panel{position:fixed;left:12px;bottom:12px;background:#0f1629;border:1px solid #1f2f57;border-radius:12px;padding:10px 12px;max-width:min(92vw,520px);z-index:10}
    .panel h3{margin:0 0 6px 0;font-size:14px;color:#9fb8ff}
    .panel p{margin:4px 0;font-size:13px;color:#cfe3ff}
  </style>
</head>
<body>
  <div class="hud">
    <button id="resetBtn" class="btn">â†© BaÅŸlangÄ±ca DÃ¶n</button>
    <button id="askPermBtn" class="btn">ðŸ“± SensÃ¶r Ä°zni (iOS)</button>
  </div>
  <div class="hint">FotoÄŸrafa tÄ±kla â†’ kamera yaklaÅŸsÄ±n Â· Telefonu eÄŸ â†’ aÄŸaÃ§ ve bayraklar sallansÄ±n</div>
  <div id="app"></div>
  <div class="panel">
    <h3>Ä°pucu</h3>
    <p><strong>images</strong> klasÃ¶rÃ¼ne aile fotoÄŸraflarÄ±nÄ± ve bayraklarÄ± ekle.</p>
    <p>AÄŸaÃ§ modelin varsa <strong>models/tree.glb</strong> dosyasÄ±nÄ± koy.</p>
  </div>
  <div class="credit">Â© <span id="y"></span> Aileniz</div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/DRACOLoader.js';

    const container = document.getElementById('app');
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    container.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 1000);
    const CAM_START = { pos:new THREE.Vector3(0,6,24), target:new THREE.Vector3(0,5,0) };
    camera.position.copy(CAM_START.pos);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.copy(CAM_START.target);
    controls.enableDamping = true;

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(10,15,10);
    scene.add(dir);

    const groundGeo = new THREE.CircleGeometry(30,64);
    const groundMat = new THREE.MeshStandardMaterial({ color:0x0f1730, roughness:1 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    // test kÃ¼p
    const cube = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({ color:0xffffff }));
    cube.position.y = 1;
    scene.add(cube);

    // === Placeholder aÄŸaÃ§ ===
    const treeRoot = new THREE.Group();
    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.7,1.0,10,12), new THREE.MeshStandardMaterial({ color:0x5b3b1a }));
    trunk.position.y = 5;
    treeRoot.add(trunk);
    const leafMat = new THREE.MeshStandardMaterial({ color:0x1e6a3a });
    [5,4,3.2].forEach((h,i)=>{
      const cone = new THREE.Mesh(new THREE.ConeGeometry(5 - i*1.2,h,16), leafMat);
      cone.position.y = 7 + i*1.8;
      treeRoot.add(cone);
    });
    scene.add(treeRoot);

    const bbox = new THREE.Box3().setFromObject(treeRoot);
    const treeTopY = bbox.max.y || 10.5;

    // === Bayrak shader ===
    const flagV = `
      uniform float uTime;
      varying vec2 vUv;
      void main(){
        vUv=uv;
        float w = sin((uv.y*20.)+uTime*2.)*0.12*smoothstep(0.,1.,uv.x);
        vec3 p=position; p.z+=w;
        gl_Position=projectionMatrix*modelViewMatrix*vec4(p,1.);
      }`;
    const flagF = `
      uniform sampler2D uMap;
      varying vec2 vUv;
      void main(){
        vec4 c=texture2D(uMap,vUv);
        if(c.a<.05)discard;
        gl_FragColor=c;
      }`;
    function makeFlag(texPath){
      const g=new THREE.PlaneGeometry(1.8,1.2,40,20);
      g.translate(0.9,0.6,0);
      const t=new THREE.TextureLoader().load(texPath);
      const m=new THREE.ShaderMaterial({
        uniforms:{uTime:{value:0},uMap:{value:t}},
        vertexShader:flagV,fragmentShader:flagF,transparent:true,side:2
      });
      const mesh=new THREE.Mesh(g,m);
      const pole=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,1.8,12),
        new THREE.MeshStandardMaterial({color:0xdddddd,metalness:.6,roughness:.3}));
      pole.position.y=0.9;
      const group=new THREE.Group();
      mesh.position.x=0.02;
      group.add(mesh,pole);
      group.userData.update=(t)=>m.uniforms.uTime.value=t;
      return group;
    }

    const flagsRoot=new THREE.Group();
    flagsRoot.position.set(0,treeTopY+0.8,0);
    const fTR=makeFlag('images/flags/tr.png');
    const fPS=makeFlag('images/flags/palestine.png');
    const fOT=makeFlag('images/flags/ottoman.png');
    fTR.position.set(-1.6,0,0.2);
    fPS.position.set(0,0,0);
    fOT.position.set(1.6,0,-0.2);
    flagsRoot.add(fTR,fPS,fOT);
    scene.add(flagsRoot);

    // === sensÃ¶r ===
    let treeRot={x:0,z:0},flgRot={x:0,y:flagsRoot.rotation.y};
    function enableSensors(){
      if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){
        DeviceMotionEvent.requestPermission().then(res=>{if(res==='granted')attach();});
      }else attach();
      function attach(){
        window.addEventListener('deviceorientation',e=>{
          const beta=e.beta||0,gamma=e.gamma||0;
          const max=0.15;
          const tx=THREE.MathUtils.degToRad(beta/90*max);
          const tz=THREE.MathUtils.degToRad(gamma/90*max);
          treeRot.x+=(tx-treeRot.x)*0.08;
          treeRot.z+=(tz-treeRot.z)*0.08;
          treeRoot.rotation.x=treeRot.x;
          treeRoot.rotation.z=treeRot.z;
          const ty=-0.2+THREE.MathUtils.degToRad(gamma/90*0.15);
          flgRot.x+=(tx-flgRot.x)*0.06;
          flgRot.y+=(ty-flgRot.y)*0.06;
          flagsRoot.rotation.x=flgRot.x;
          flagsRoot.rotation.y=flgRot.y;
        });
      }
    }
    document.getElementById('askPermBtn').addEventListener('click',enableSensors);
    enableSensors();

    document.getElementById('resetBtn').addEventListener('click',()=>{
      camera.position.copy(CAM_START.pos);
      controls.target.copy(CAM_START.target);
    });

    document.getElementById('y').textContent=new Date().getFullYear();

    const clock=new THREE.Clock();
    function animate(){
      const t=clock.getElapsedTime();
      [fTR,fPS,fOT].forEach(f=>f.userData.update(t));
      controls.update();
      renderer.render(scene,camera);
      requestAnimationFrame(animate);
    }
    animate();
  </script>
</body>
</html>
